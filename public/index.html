<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shareable KYC Link Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../public/chain.json"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  
  <style>
    /* Theme Variables */
    :root {
      --theme-primary: #6366f1;
      --theme-secondary: #4f46e5;
      --theme-background: #f9fafb;
      --theme-surface: #ffffff;
      --theme-text: #1f2937;
      --theme-text-secondary: #6b7280;
      --theme-border: #e5e7eb;
      --theme-accent: #8b5cf6;
    }

    /* Vibrant Theme */
    [data-theme="vibrant"] {
      --theme-primary: #8b5cf6;
      --theme-secondary: #7c3aed;
      --theme-background: #faf5ff;
      --theme-surface: #ffffff;
      --theme-text: #1e1b4b;
      --theme-text-secondary: #6b7280;
      --theme-border: #e9d5ff;
      --theme-accent: #ec4899;
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --theme-primary: #3b82f6;
      --theme-secondary: #1d4ed8;
      --theme-background: #0f172a;
      --theme-surface: #1e293b;
      --theme-text: #f1f5f9;
      --theme-text-secondary: #94a3b8;
      --theme-border: #334155;
      --theme-accent: #06b6d4;
    }

    /* Grey Theme */
    [data-theme="grey"] {
      --theme-primary: #6b7280;
      --theme-secondary: #4b5563;
      --theme-background: #f3f4f6;
      --theme-surface: #ffffff;
      --theme-text: #374151;
      --theme-text-secondary: #6b7280;
      --theme-border: #d1d5db;
      --theme-accent: #9ca3af;
    }

    /* Light Theme */
    [data-theme="light"] {
      --theme-primary: #6366f1;
      --theme-secondary: #4f46e5;
      --theme-background: #f9fafb;
      --theme-surface: #ffffff;
      --theme-text: #111827;
      --theme-text-secondary: #6b7280;
      --theme-border: #e5e7eb;
      --theme-accent: #8b5cf6;
    }

    /* Apply theme colors */
    body {
      background-color: var(--theme-background);
      color: var(--theme-text);
      transition: all 0.3s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Theme-aware card background */
    .theme-card {
      background-color: var(--theme-surface);
      border: 1px solid var(--theme-border);
    }

    .theme-button {
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
      color: white;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .theme-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .theme-icon {
      color: var(--theme-primary);
    }

    .theme-title {
      color: var(--theme-text);
    }

    .theme-subtitle {
      color: var(--theme-text-secondary);
    }

    /* Theme Selector Styles */
    .theme-selector {
      position: fixed;
      top: 80px;
      right: 30px;
      z-index: 1000;
    }

    .theme-selector-container {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .theme-option {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .theme-option:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .theme-option.active {
      border-color: var(--theme-text);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .theme-option.active::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .theme-vibrant { background: linear-gradient(45deg, #8b5cf6, #ec4899); }
    .theme-dark { background: linear-gradient(45deg, #1e293b, #3b82f6); }
    .theme-grey { background: linear-gradient(45deg, #6b7280, #9ca3af); }
    .theme-light { background: linear-gradient(45deg, #6366f1, #8b5cf6); }

    /* Responsive Design */
    @media (max-width: 768px) {
      .theme-selector {
        top: 20px;
        right: 20px;
      }
      
      .theme-option {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body data-theme="light" class="min-h-screen flex flex-col justify-center items-center pt-12">

  <!-- Sandbox Warning Banner -->
  <div id="sandboxBanner" class="fixed top-0 left-0 right-0 bg-yellow-100 border-b border-yellow-200 px-4 py-3 z-50">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
          <i data-feather="alert-triangle" class="h-5 w-5 text-yellow-600"></i>
        </div>
        <p class="text-sm text-yellow-800">
          You are in sandbox mode. No real checks will be performed.
        </p>
      </div>
      <button onclick="closeSandboxBanner()" class="text-yellow-600 hover:text-yellow-800">
        <i data-feather="x" class="h-4 w-4"></i>
      </button>
    </div>
  </div>

  <!-- Theme Selector -->
  <div class="theme-selector">
    <div class="theme-selector-container p-4">
      <h3 class="text-sm font-semibold mb-3 text-center text-gray-700">Choose Theme</h3>
      <div class="flex space-x-3">
        <div class="theme-option theme-vibrant" data-theme="vibrant" title="Vibrant"></div>
        <div class="theme-option theme-dark active" data-theme="dark" title="Dark"></div>
        <div class="theme-option theme-grey" data-theme="grey" title="Grey"></div>
        <div class="theme-option theme-light" data-theme="light" title="Light"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="flex items-center space-x-4 mb-10">
    <img id="logo" src="https://nibiru.fi/_astro/nibi-logomark-profile-pic.DoOUhpoa.svg" alt="Nibiru Logo" class="h-12 w-12 rounded-full">
    <h1 class="theme-title text-3xl font-bold">Nibiru Finance</h1>
  </header>

  <!-- Central Section with Horizontal Steps -->
  <section class="theme-card flex flex-col items-center p-8 rounded-2xl shadow-lg max-w-md w-full space-y-6">
    <!-- Title + Description -->
    <div class="text-center">
      <h2 class="theme-title text-3xl font-bold mb-2">Verify Your Identity</h2>
      <p class="theme-subtitle">Please read the Terms & Conditions before proceeding</p>
    </div>

    <!-- Steps stacked vertically, each step is horizontal -->
    <div class="flex flex-col space-y-4 w-full">
      <div class="flex items-center space-x-4">
        <i data-feather="camera" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Take Selfie</span>
          <span class="theme-subtitle text-sm">Capture a clear photo of yourself.</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <i data-feather="credit-card" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Verify ID Document</span>
          <span class="theme-subtitle text-sm">Upload your ID for verification.</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <i data-feather="file-text" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Provide Consent</span>
          <span class="theme-subtitle text-sm">Agree to securely share your information.</span>
        </div>
      </div>
    </div>

    <!-- Call to Action -->
    <button id="load2" class="theme-button mt-4 font-semibold px-6 py-2 rounded-xl shadow-lg transition-all duration-300" style="display:none">
      <i class="bi bi-person-bounding-box"></i> Start KYC Verification
    </button>
    
    <!-- Result and Error Display -->
    <div id="result" class="w-full"></div>
    <div id="errorData" class="w-full"></div>
  </section>

  <!-- Browser Modal -->
  <div id="browserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-sm w-full text-center">
      <h3 class="font-bold text-lg mb-4 text-red-600">Unsupported Browser</h3>
      <p class="mb-6 text-gray-700">❌ This site only works on Google Chrome. Please switch to Chrome for the best experience.</p>
      <button id="closeBrowserModal" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">Close</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="theme-subtitle mt-12 text-sm text-center space-y-1">
    <div>Powered by <span class="font-semibold">Hypersign</span></div>
    <div>Contact: <a href="mailto:support@nibirufinance.com" class="underline">support@nibirufinance.com</a></div>
  </footer>

  <script>
    feather.replace();

    // Sandbox Banner Management
    function closeSandboxBanner() {
      const banner = document.getElementById('sandboxBanner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    // Theme Management
    const themes = ['vibrant', 'dark', 'grey', 'light'];
    let currentTheme = 'dark'; // Default theme

    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      currentTheme = theme;
      
      // Update active state in theme selector
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
      
      // Store theme preference
      localStorage.setItem('preferred-theme', theme);
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('preferred-theme');
      if (savedTheme && themes.includes(savedTheme)) {
        setTheme(savedTheme);
      } else {
        setTheme('dark'); // Default to dark theme
      }
    }

    // Theme selector event listeners
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        setTheme(theme);
      });
    });

    // Initialize theme on page load
    initializeTheme();

    window.onload = async function () {
        // Load both local JSON data and API config
        await loadJSONData();
        await loadKYCConfigFromAPI();
        
        if (!isChromeBrowser()) {
            document.getElementById('browserModal').classList.remove('hidden');
            document.getElementById('browserModal').classList.add('flex');
        } else {
            document.getElementById('load2').style.display = 'block';
        }
    };

    // Browser Modal functionality
    const closeBrowserModal = document.getElementById('closeBrowserModal');
    const browserModal = document.getElementById('browserModal');

    closeBrowserModal.addEventListener('click', () => {
        browserModal.classList.add('hidden');
        browserModal.classList.remove('flex');
    });
    function isChromeBrowser() {
        const userAgent = navigator.userAgent;
        const isChromium = userAgent.includes("Chrome") || userAgent.includes("Chromium");
        const isEdge = userAgent.includes("Edg/");
        const isOpera = userAgent.includes("OPR/");
        const isBrave = navigator.brave !== undefined;

        // Chrome must be Chromium-based, not Edge/Opera/Brave
        return isChromium && !isEdge && !isOpera && !isBrave;
    }
    function getCustomerId(url) {
        try {
            const parsedUrl = new URL(url);
            const pathSegments = parsedUrl.pathname.split('/').filter(Boolean); // remove empty segments

            // Check if the last segment looks like a userId
            const userId = pathSegments.length > 0 ? pathSegments[pathSegments.length - 1] : null;

            return userId || "13f70faf7f5c5d03520b71181136b595f7c6";
        } catch (err) {
            console.error("Invalid URL:", err.message);
            return "13f70faf7f5c5d03520b71181136b595f7c6";
        }
    }

    let ssiAccessToken;
    let kycAccessToken
    let teneantUrl
    let tokenData
    // New function to load KYC config from API
    async function loadKYCConfigFromAPI() {
        try {
            const id = getCustomerId(window.location.href);
            
            // Call the new API endpoint
            const response = await fetch(`https://api.entity.dashboard.hypersign.id/api/v1/app/${id}/kyc-webpage-config`, {
                method: 'GET',
                credentials: 'include', // This includes cookies in the request
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const configData = await response.json();
            console.log('KYC Config loaded from API:', configData);

            // Update UI based on API response
            if (configData?.pageTitle) {
                const titleElement = document.querySelector('h2');
                if (titleElement) {
                    titleElement.textContent = configData.pageTitle;
                }
            }
            
            if (configData?.pageDescription) {
                const descElement = document.querySelector('p');
                if (descElement) {
                    descElement.textContent = configData.pageDescription;
                }
            }
            
            // Update theme if provided
            if (configData?.themeColor && themes.includes(configData.themeColor)) {
                setTheme(configData.themeColor);
            }
            
            // Update tenant URL if provided
            if (configData?.tenantUrl) {
                teneantUrl = configData.tenantUrl;
            }
            
        } catch (error) {
            console.error('Error loading KYC config from API:', error);
            // API failure is not critical, continue with local data
        }
    }

    // Original function to load local JSON data
    async function loadJSONData() {
        try {
            const id = getCustomerId(window.location.href)

            const response = await fetch('tokenDetail.json');
            tokenData = await response.json();
            const matchedData = tokenData.find((tokenDetail) => tokenDetail.id === id)
            ssiAccessToken = matchedData?.ssiAccessToken ?? "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6ImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX3NzaSIsImttc0lkIjoiaHM6ZG9jOmUwbGtycWZheW5xbWNsMWh4MjVmY3htODdtMnBjemVrbTh2dm5zemFqbGEiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiJdLCJzdWJkb21haW4iOiJlbnQtOGEyZGU1YSIsImVkdklkIjoiaHM6ZGV2ZWxvcGVyLWRhc2hib2FyZDphcHA6ZGM4ZTgxYzM0ZGI4NDliNzQyYWMyMWU1YTljZmJhMzA1NTAyIiwiYWNjZXNzTGlzdCI6WyJBTEwiXSwiZW52IjoiZGV2IiwiYXBwTmFtZSI6IlNTSSBTZXJ2aWNlIEZvciBNeURlZmkiLCJpYXQiOjE3MjI2MTcwOTQsImV4cCI6MjI0Mjc4MTA5NH0.CAWghRvyzm2i7qpN5e4vtJkNilBiNndGBLV-DaWqd0w"
            kycAccessToken = matchedData?.kycAccessToken ?? "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6IjEzZjcwZmFmN2Y1YzVkMDM1MjBiNzExODExMzZiNTk1ZjdjNiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX2t5YyIsImttc0lkIjoiaHM6ZG9jOm15cWJldHlwNnctazB6anlkY3liYXZvbncxNGZnb2UzN2RhcDR5Y2NpbzAiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiIsImh0dHBzOi8vZW50aXR5LmRhc2hib2FyZC5oeXBlcnNpZ24uaWQiLCJodHRwczovL3ZlcmlmeS5oeXBlcnNpZ24uaWQiXSwic3ViZG9tYWluIjoiZW50LTRjNzE4NzQiLCJlZHZJZCI6ImhzOmRldmVsb3Blci1kYXNoYm9hcmQ6YXBwOjU0Nzc0OWIyODJmNjI4N2Q3YzhhNjk2MDllNDE5NGFmOTY0YyIsImFjY2Vzc0xpc3QiOlsiQUxMIiwiUkVBRF9VU0VSX0NPTlNFTlQiLCJXUklURV9VU0VSX0NPTlNFTlQiLCJXUklURV9QQVNTSVZFX0xJVkVMSU5FU1MiLCJXUklURV9ET0NfT0NSIl0sImVudiI6ImRldiIsImFwcE5hbWUiOiJOaWJpcnUgKG15RGVmaSkgT25jaGFpbiBLWUMgQXBwIiwiaXNzdWVyRGlkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiIsImlzc3VlclZlcmlmaWNhdGlvbk1ldGhvZElkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiNrZXktMiIsImRlcGVuZGVudFNlcnZpY2VzIjpbImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiJdLCJpYXQiOjE3MzI3NzMzNzIsImV4cCI6MTg5Mjc4MjU3Mn0.C6vKRubBQQDL_TYwp2RE59YgGlcLdifr_jxBsPzSIPw"
            teneantUrl = matchedData?.teneantUrl ?? "https://ent-4c71874.api.cavach.hypersign.id"
            document.getElementById("logo").src = matchedData.logoUrl;
        } catch (error) {
            console.error('Error loading the JSON file:', error);
            ssiAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6ImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX3NzaSIsImttc0lkIjoiaHM6ZG9jOmUwbGtycWZheW5xbWNsMWh4MjVmY3htODdtMnBjemVrbTh2dm5zemFqbGEiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiJdLCJzdWJkb21haW4iOiJlbnQtOGEyZGU1YSIsImVkdklkIjoiaHM6ZGV2ZWxvcGVyLWRhc2hib2FyZDphcHA6ZGM4ZTgxYzM0ZGI4NDliNzQyYWMyMWU1YTljZmJhMzA1NTAyIiwiYWNjZXNzTGlzdCI6WyJBTEwiXSwiZW52IjoiZGV2IiwiYXBwTmFtZSI6IlNTSSBTZXJ2aWNlIEZvciBNeURlZmkiLCJpYXQiOjE3MjI2MTcwOTQsImV4cCI6MjI0Mjc4MTA5NH0.CAWghRvyzm2i7qpN5e4vtJkNilBiNndGBLV-DaWqd0w"
            kycAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6IjEzZjcwZmFmN2Y1YzVkMDM1MjBiNzExODExMzZiNTk1ZjdjNiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX2t5YyIsImttc0lkIjoiaHM6ZG9jOm15cWJldHlwNnctazB6anlkY3liYXZvbncxNGZnb2UzN2RhcDR5Y2NpbzAiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiIsImh0dHBzOi8vZW50aXR5LmRhc2hib2FyZC5oeXBlcnNpZ24uaWQiLCJodHRwczovL3ZlcmlmeS5oeXBlcnNpZ24uaWQiXSwic3ViZG9tYWluIjoiZW50LTRjNzE4NzQiLCJlZHZJZCI6ImhzOmRldmVsb3Blci1kYXNoYm9hcmQ6YXBwOjU0Nzc0OWIyODJmNjI4N2Q3YzhhNjk2MDllNDE5NGFmOTY0YyIsImFjY2Vzc0xpc3QiOlsiQUxMIiwiUkVBRF9VU0VSX0NPTlNFTlQiLCJXUklURV9VU0VSX0NPTlNFTlQiLCJXUklURV9QQVNTSVZFX0xJVkVMSU5FU1MiLCJXUklURV9ET0NfT0NSIl0sImVudiI6ImRldiIsImFwcE5hbWUiOiJOaWJpcnUgKG15RGVmaSkgT25jaGFpbiBLWUMgQXBwIiwiaXNzdWVyRGlkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiIsImlzc3VlclZlcmlmaWNhdGlvbk1ldGhvZElkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiNrZXktMiIsImRlcGVuZGVudFNlcnZpY2VzIjpbImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiJdLCJpYXQiOjE3MzI3NzMzNzIsImV4cCI6MTg5Mjc4MjU3Mn0.C6vKRubBQQDL_TYwp2RE59YgGlcLdifr_jxBsPzSIPw"
            teneantUrl = "https://ent-4c71874.api.cavach.hypersign.id"
            document.getElementById("logo").src = "https://i.ibb.co/MRV1T6k/mydefi-high-resolution-logo-black-transparent.png";
        }
    }

    const widgetBaseUrl = "https://verify.hypersign.id/"
    const consentAPIpath = '/api/v1/e-kyc/verification/user-consent'
    const kycSessionPath = '/api/v1/e-kyc/verification/session'
    let idwidgetPopup;
    let popupChecker;

    let idTokenGbl = ""

    function onError(message) {
        const errorDom = document.getElementById('errorData')
        if (errorDom) {
            errorDom.style.display = 'block'
            errorDom.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-2xl" role="alert">
                 ${message ? message : `
                        Failed to verify the user, please try again!
                    `}
            </div>
            <div class="text-center mt-3 text-lg text-gray-600">Please reload the page and try again</div>
            `
        }
        const button = document.getElementById('load2')
        if (button) {
            button.style.display = 'none'
            button.innerHTML = `<i class="bi bi-person-bounding-box mr-3"></i> Start KYC Verification`
        }
    }

    window.addEventListener('message', function (event) {

        if ((new URL(event.origin)).origin === (new URL(widgetBaseUrl)).origin) {
            clearInterval(popupChecker);
            const data = JSON.parse(event.data)
            // Handle the message data sent from the popup
            console.log('Received message from popup:', event.data);
            if (data.status === 'success') {
                const result = document.getElementById('result')
                result.innerHTML = `<h2 class="text-green-600 text-center text-2xl font-bold"><i class="bi bi-check-circle mr-3"></i> You are verified!</h2>`
                document.getElementById('load2').style.display = 'none'
            }
            else if (data.status === 'error') {
                console.log({ data })
                onError(data.message)
            }
        }
    });
    
    $('#load2').on('click', async function () {
        try {
            var $this = $(this);
            $this.button('loading');
            const button = document.getElementById('load2')
            button.innerHTML = `<span class="spinner-grow spinner-grow-sm mr-3"></span> Verifying User...`
            const url = await getWidgetUrl()
            console.log(url)
            if (url) openMobileWindow(url);
        } catch (e) {
            console.log(e)
            onError(e.message)
            alert(e.message)
        }
    });

    function openMobileWindow(url) {
        // Define the dimensions for a typical mobile phone (e.g., iPhone 12)
        const mobileWidth = 450; // Adjust as needed
        const mobileHeight = 750; // Adjust as needed

        // Get the screen dimensions
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;

        // Calculate the position to center the window
        const left = (screenWidth - mobileWidth) / 2;
        const top = (screenHeight - mobileHeight) / 2;

        // Open the window
        idwidgetPopup = window.open(
            url, // Replace with your desired URL
            '_blank',
            `width=${mobileWidth},height=${mobileHeight},left=${left},top=${top},resizable,scrollbars`
        );

        popupChecker = setInterval(() => {
            console.log('Checking popup status...')
            if (idwidgetPopup.closed) {
                console.log('Popup closed');
                clearInterval(popupChecker);
                // popup was closed manually (accident or on purpose)
                onError('Seems like you rejected the verification request!')
                // handle rejection logic here
            }
        }, 500);
    }

    async function fetchNewKYCSession() {
        const idToken = idTokenGbl
        const url = `${teneantUrl}${kycSessionPath}`
        const headers = {
            'Authorization': 'Bearer ' + kycAccessToken,
            'content-type': 'application/json',
        }
        const resp = await fetch(url, {
            method: 'POST',
            headers
        })

        const json = await resp.json()

        if (json && json.error) {
            console.log(json.error.details?.join(' '))
            throw new Error(json.error.details?.join(' '))
        }
        console.log(json)
        return json.data;
    }

    async function getWidgetUrl() {
        const { sessionId } = await fetchNewKYCSession()
        if (sessionId) {
            const finalUrl = `${widgetBaseUrl}?kycAccessToken=${kycAccessToken}&ssiAccessToken=${ssiAccessToken}&sessionId=${sessionId}`
            return finalUrl
        } else {
            const finalUrl = `${widgetBaseUrl}?kycAccessToken=${kycAccessToken}&ssiAccessToken=${ssiAccessToken}`
            return finalUrl
        }
    }
  </script>
</body>
</html>