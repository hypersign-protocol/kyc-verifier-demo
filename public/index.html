<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shareable KYC Link Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../public/chain.json"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    /* Theme Variables */
    :root {
      --theme-primary: #6366f1;
      --theme-secondary: #4f46e5;
      --theme-background: #f9fafb;
      --theme-surface: #ffffff;
      --theme-text: #1f2937;
      --theme-text-secondary: #6b7280;
      --theme-border: #e5e7eb;
      --theme-accent: #8b5cf6;
    }

    /* Vibrant Theme */
    [data-theme="vibrant"] {
      --theme-primary: #8b5cf6;
      --theme-secondary: #7c3aed;
      --theme-background: #faf5ff;
      --theme-surface: #ffffff;
      --theme-text: #1e1b4b;
      --theme-text-secondary: #6b7280;
      --theme-border: #e9d5ff;
      --theme-accent: #ec4899;
    }

    /* Dark Theme */
    [data-theme="dark"] {
      /* Requested purple: rgba(132, 82, 162, 1) */
      --theme-primary: rgba(132, 82, 162, 1); /* #8452A2 */
      --theme-secondary: rgba(103, 64, 126, 1); /* ~20% darker of primary: #67407E */
      --theme-background: #0f172a;
      --theme-surface: #1e293b;
      --theme-text: #f1f5f9;
      --theme-text-secondary: #94a3b8;
      --theme-border: #334155;
      --theme-accent: rgba(132, 82, 162, 1);
    }

    /* Grey Theme */
    [data-theme="grey"] {
      --theme-primary: #6b7280;
      --theme-secondary: #4b5563;
      --theme-background: #f3f4f6;
      --theme-surface: #ffffff;
      --theme-text: #374151;
      --theme-text-secondary: #6b7280;
      --theme-border: #d1d5db;
      --theme-accent: #9ca3af;
    }

    /* Light Theme */
    [data-theme="light"] {
      --theme-primary: #6366f1;
      --theme-secondary: #4f46e5;
      --theme-background: #f9fafb;
      --theme-surface: #ffffff;
      --theme-text: #111827;
      --theme-text-secondary: #6b7280;
      --theme-border: #e5e7eb;
      --theme-accent: #8b5cf6;
    }

    /* Apply theme colors */
    body {
      background-color: var(--theme-background);
      color: var(--theme-text);
      transition: all 0.3s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Theme-aware card background */
    .theme-card {
      background-color: var(--theme-surface);
      border: 1px solid var(--theme-border);
    }

    .theme-button {
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
      color: white;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Button color for dark theme uses the same purple variables */
    [data-theme="dark"] .theme-button {
      background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-secondary) 100%);
    }

    .theme-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .theme-icon {
      color: var(--theme-primary);
    }
    [data-theme="dark"] .theme-icon { color: var(--theme-primary); }

    .theme-title {
      color: var(--theme-text);
    }

    .theme-subtitle {
      color: var(--theme-text-secondary);
    }

    /* Theme Selector Styles */
    .theme-selector {
      position: fixed;
      top: 80px;
      right: 30px;
      z-index: 1000;
    }

    .theme-selector-container {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .theme-option {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .theme-option:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .theme-option.active {
      border-color: var(--theme-text);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .theme-option.active::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .theme-vibrant { background: linear-gradient(45deg, #8b5cf6, #ec4899); }
    .theme-dark { background: linear-gradient(45deg, #1e293b, #3b82f6); }
    .theme-grey { background: linear-gradient(45deg, #6b7280, #9ca3af); }
    .theme-light { background: linear-gradient(45deg, #6366f1, #8b5cf6); }

    /* Powered-by logo: adapt for dark theme visibility */
    [data-theme="dark"] #poweredByLogo {
      filter: invert(1) brightness(1.6) contrast(1.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .theme-selector {
        top: 20px;
        right: 20px;
      }
      
      .theme-option {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body data-theme="light" class="min-h-screen flex flex-col justify-center items-center pt-12">

  <!-- Sandbox Warning Banner (centered to content width, initially hidden) -->
  <div id="sandboxBanner" class="fixed top-0 left-0 right-0 bg-yellow-100 border-b border-yellow-200 px-4 py-3 z-50 hidden">
    <div class="relative mx-auto max-w-md w-full">
      <div class="flex items-center justify-center text-center">
        <i data-feather="alert-triangle" class="h-5 w-5 text-yellow-600 mr-2"></i>
        <p id="sandboxBannerText" class="text-sm text-yellow-800">You are in sandbox mode. No real checks will be performed.</p>
      </div>
      <button onclick="closeSandboxBanner()" class="absolute top-0 right-0 text-yellow-600 hover:text-yellow-800">
        <i data-feather="x" class="h-4 w-4"></i>
      </button>
    </div>
  </div>

  <!-- Theme Selector -->
  <!-- <div class="theme-selector">
    <div class="theme-selector-container p-4">
      <h3 class="text-sm font-semibold mb-3 text-center text-gray-700">Choose Theme</h3>
      <div class="flex space-x-3">
        <div class="theme-option theme-vibrant" data-theme="vibrant" title="Vibrant"></div>
        <div class="theme-option theme-dark active" data-theme="dark" title="Dark"></div>
        <div class="theme-option theme-grey" data-theme="grey" title="Grey"></div>
        <div class="theme-option theme-light" data-theme="light" title="Light"></div>
      </div>
    </div>
  </div> -->



  <!-- Central Section with Horizontal Steps -->
  <section class="theme-card flex flex-col items-center p-8 rounded-2xl shadow-lg max-w-md w-full space-y-4">
    
    <!-- Header: logo on left, titles stacked on right -->
    <header class="flex items-center space-x-4 mb-2 w-full">
      <img id="logo" class="h-12 w-12 rounded-full flex-shrink-0" alt="Service Logo" title="Service logo" style="display:none" onerror="handleLogoError(this)" onload="handleLogoLoad(this)">
      <div class="flex flex-col text-left w-full">
        <h1 id="title" class="theme-title text-3xl font-bold leading-tight">Hypersign KYC</h1>
        <h2 id="pageTitle" class="theme-title text-2xl leading-snug">Verify Your Identity</h2>
      </div>
    </header>
    <!-- Title + Description -->
    <div class="">
      <p id="pageSubtitle" class="theme-subtitle text-left mt-0">Please read the Terms & Conditions before proceeding</p>
    </div>

    <!-- Steps stacked vertically, each step is horizontal -->
    <div class="flex flex-col space-y-4 w-full mb-3">
      <div class="flex items-center space-x-4">
        <i data-feather="camera" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Take Selfie</span>
          <span class="theme-subtitle text-sm">Capture a clear photo of yourself.</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <i data-feather="credit-card" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Verify ID Document</span>
          <span class="theme-subtitle text-sm">Upload your ID for verification.</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <i data-feather="file-text" class="theme-icon h-6 w-6 flex-shrink-0"></i>
        <div class="flex flex-col text-left">
          <span class="theme-title font-semibold text-base">Provide Consent</span>
          <span class="theme-subtitle text-sm">Agree to securely share your information.</span>
        </div>
      </div>
    </div>

    <!-- Call to Action -->
    <button id="load2" class="theme-button mt-2 font-semibold px-6 py-2 rounded-xl shadow-lg transition-all duration-300" style="display:none">
      <i class="bi bi-shield"></i> Start KYC Verification
    </button>
    
    <!-- Result and Error Display (fixed height, scroll inside) -->
    <div id="messageArea" class="w-full max-h-[8rem] overflow-y-hidden overflow-x-hidden py-1 mb-1">
      <div id="result" class="w-full"></div>
      <div id="errorData" class="w-full"></div>
    </div>

    <!-- Contact -->
    <div id="contactWrapper" class="text-base md:text-lg theme-subtitle">
      <span class="font-medium">Contact:</span> <a id="contactEmail" class="underline"></a>
    </div>
  </section>

  <!-- Browser Modal -->
  <div id="browserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-sm w-full text-center">
      <h3 class="font-bold text-lg mb-4 text-red-600">Unsupported Browser</h3>
      <p class="mb-6 text-gray-700">❌ This site only works on Google Chrome. Please switch to Chrome for the best experience.</p>
      <button id="closeBrowserModal" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">Close</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="theme-subtitle mt-8 text-center space-y-2">
    <div>
      <a href="https://hypersign.id" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2">
        <span class="theme-subtitle">Powered by</span>
        <img id="poweredByLogo" src="assets/Logo.png" alt="Hypersign" class="h-5 md:h-6 inline-block" />
      </a>
    </div>
  </footer>

  <script>
    feather.replace();

    // Sandbox Banner Management
    function closeSandboxBanner() {
      const banner = document.getElementById('sandboxBanner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    function setSandboxBanner(stage) {
      const banner = document.getElementById('sandboxBanner');
      const text = document.getElementById('sandboxBannerText');
      if (!banner || !text) return;

      if (!stage) {
        text.textContent = 'developmentStage not found';
        banner.classList.remove('hidden');
        banner.style.display = 'block';
        return;
      }

      const normalized = String(stage).toLowerCase();
      if (normalized === 'dev') {
        text.textContent = 'You are in sandbox mode. No real checks will be performed.';
        banner.classList.remove('hidden');
        banner.style.display = 'block';
      } else if (normalized === 'prod') {
        banner.classList.add('hidden');
        banner.style.display = 'none';
      } else {
        text.textContent = `developmentStage not found`;
        banner.classList.remove('hidden');
        banner.style.display = 'block';
      }
    }

    // Theme Management
    const themes = ['vibrant', 'dark', 'grey', 'light'];
    let currentTheme = 'dark'; // Default theme

    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      currentTheme = theme;
      
      // Update active state in theme selector
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
      
      // Store theme preference
      localStorage.setItem('preferred-theme', theme);
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('preferred-theme');
      if (savedTheme && themes.includes(savedTheme)) {
        setTheme(savedTheme);
      } else {
        setTheme('dark'); // Default to dark theme
      }
    }

    // Theme selector event listeners
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        setTheme(theme);
      });
    });

    // Initialize theme on page load
    initializeTheme();

    window.onload = async function () {
        // Check for customer ID first
        const customerId = getCustomerId(window.location.href);
        
        if (!customerId) {
            // Show error message when no customer ID is provided
            const errorDom = document.getElementById('errorData');
            const resultDom = document.getElementById('result');
            const button = document.getElementById('load2');
            const logoImg = document.getElementById('logo');
            const header = logoImg ? logoImg.parentElement : null;
            
            if (errorDom) {
                errorDom.style.display = 'block';
                errorDom.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 text-gray-700 px-4 py-3 rounded-xl" role="alert">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="bi bi-info-circle mr-2 text-lg text-gray-600"></i>
                      <span class="font-semibold">Customer ID required</span>
                    </div>
                    <button id="cidReadMore" class="text-xs font-medium text-gray-700 hover:text-gray-900 underline">Read more</button>
                  </div>
                  <div id="cidDetails" class="hidden mt-2 text-sm text-gray-700 overflow-x-auto overflow-y-hidden whitespace-nowrap">
                    Please provide a valid customer ID in the URL to activate this page. · Get your customer ID by logging into <span class="font-medium">Entity Studio</span> and generating your custom branded page. · The link will look like <code class="bg-gray-100 px-2 py-1 rounded break-all">https://verifier.hypersign.id/&lt;your-customer-id&gt;</code> (e.g. <code class="bg-gray-100 px-2 py-1 rounded break-all">https://verifier.hypersign.id/shsy67stshan</code>).
                  </div>
                </div>
                `;
                const readMoreBtn = document.getElementById('cidReadMore');
                if (readMoreBtn) {
                    readMoreBtn.addEventListener('click', function () {
                        const details = document.getElementById('cidDetails');
                        if (!details) return;
                        const isHidden = details.classList.toggle('hidden');
                        readMoreBtn.textContent = isHidden ? 'Read more' : 'Hide';
                    });
                }
            }
            
            // Hide the button
            if (button) {
                button.style.display = 'none';
            }
            
            // Swap logo image with a CSS/icon fallback
            if (logoImg && header) {
                logoImg.style.display = 'none';
                if (!document.getElementById('logoFallback')) {
                    const fallback = document.createElement('div');
                    fallback.id = 'logoFallback';
                    fallback.className = 'h-12 w-12 rounded-full flex items-center justify-center bg-gray-200 text-gray-600';
                    fallback.innerHTML = '<i class="bi bi-shield-lock"></i>';
                    header.insertBefore(fallback, header.firstChild);
                }
            }
            
            // Clear any existing result and hide contact
            if (resultDom) {
                resultDom.innerHTML = '';
            }
            const contactWrapper = document.getElementById('contactWrapper');
            if (contactWrapper) contactWrapper.style.display = 'none';
            
            return; // Exit early, don't load config or show button
        }
        
        // Attach logo handlers early
        attachLogoHandlers();

        // Clear any existing error messages
        clearError();
        
        // Ensure logo image is visible and remove fallback if present
        (function restoreLogo() {
            const logoImg = document.getElementById('logo');
            const fallback = document.getElementById('logoFallback');
            if (fallback && fallback.parentElement) {
                fallback.parentElement.removeChild(fallback);
            }
            if (logoImg) {
                logoImg.style.display = '';
            }
        })();
        
        // Load both local JSON data and API config
        // await loadJSONData();
        const configOk = await loadKYCConfigFromAPI();
        
        if (!isChromeBrowser()) {
            document.getElementById('browserModal').classList.remove('hidden');
            document.getElementById('browserModal').classList.add('flex');
        } else if (configOk) {
            document.getElementById('load2').style.display = 'block';
        } else {
            const button = document.getElementById('load2');
            if (button) button.style.display = 'none';
            const contactWrapper = document.getElementById('contactWrapper');
            if (contactWrapper) contactWrapper.style.display = 'none';
        }
    };

    // Browser Modal functionality
    const closeBrowserModal = document.getElementById('closeBrowserModal');
    const browserModal = document.getElementById('browserModal');

    closeBrowserModal.addEventListener('click', () => {
        browserModal.classList.add('hidden');
        browserModal.classList.remove('flex');
    });
    function isChromeBrowser() {
        const userAgent = navigator.userAgent;
        const isChromium = userAgent.includes("Chrome") || userAgent.includes("Chromium");
        const isEdge = userAgent.includes("Edg/");
        const isOpera = userAgent.includes("OPR/");
        const isBrave = navigator.brave !== undefined;

        // Chrome must be Chromium-based, not Edge/Opera/Brave
        return isChromium && !isEdge && !isOpera && !isBrave;
    }
    function getCustomerId(url) {
        try {
            const parsedUrl = new URL(url);

            // 1) Try query parameters (case-insensitive keys)
            const params = parsedUrl.searchParams;
            let candidateFromQuery = null;
            params.forEach((value, key) => {
                const k = String(key).toLowerCase();
                if (k === 'customerid' || k === 'customer-id' || k === 'id') {
                    if (!candidateFromQuery) candidateFromQuery = value;
                }
            });
            if (candidateFromQuery && String(candidateFromQuery).trim().length > 0) {
                return String(candidateFromQuery).trim();
            }

            // 2) Fallback to last path segment if it looks like an ID
            const pathSegments = parsedUrl.pathname.split('/').filter(Boolean);
            const last = pathSegments.length > 0 ? pathSegments[pathSegments.length - 1] : '';
            const normalizedLast = String(last).trim();
            const isHtml = /\.html?$/.test(normalizedLast);
            const idLike = /^[A-Za-z0-9_-]{6,64}$/.test(normalizedLast);
            if (!isHtml && idLike) {
                return normalizedLast;
            }

            return null;
        } catch (err) {
            console.error('Invalid URL:', err.message);
            return null;
        }
    }

    let ssiAccessToken;
    let kycAccessToken
    let teneantUrl
    let tokenData
    // New function to load KYC config from API
    async function loadKYCConfigFromAPI() {
        try {
            const id = getCustomerId(window.location.href);
            
            // If no customer ID, don't proceed with API call
            if (!id) {
                console.warn('No customer ID provided, skipping API config load');
                return false;
            }
            
            // Call the new API endpoint
          const response = await fetch(`https://api.entity.dashboard.hypersign.id/api/v1/app/${id}/kyc-webpage-config`, {         
          //const response = await fetch(`http://localhost:3002/api/v1/app/${id}/kyc-webpage-config`, {     
           method: 'GET',
                credentials: 'include', // This includes cookies in the request
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const configData = await response.json();
            console.log('KYC Config loaded from API:', configData);

            // Update UI based on API response
            const logoImg = document.getElementById('logo');
            if (configData?.logoUrl && logoImg) {
                logoImg.src = configData.logoUrl;
            } else {
                handleLogoError(logoImg)
            }
            if (configData?.serviceName) {
                const titleElement = document.getElementById('title');
                if (titleElement) {
                    titleElement.textContent = configData.serviceName;
                }
            }

            if (configData?.pageTitle) {
                const titleElement = document.getElementById('pageTitle');
                if (titleElement) {
                    titleElement.textContent = configData.pageTitle;
                }
            }
            if (configData?.pageDescription) {
                const descElement = document.getElementById('pageSubtitle');
                if (descElement) {
                    descElement.textContent = configData.pageDescription;
                }
            }
            // Update theme if provided
            if (configData?.themeColor && themes.includes(configData.themeColor)) {
                setTheme(configData.themeColor);
            }
            // Set sandbox banner based on developmentStage
            setSandboxBanner(configData?.developmentStage);
            // Update tenant URL if provided
            if (configData?.tenantUrl) {
                teneantUrl = configData.tenantUrl;
            }
            if(configData?.ssiAccessToken){
                 ssiAccessToken= configData?.ssiAccessToken
            }
             if(configData?.kycAccessToken){
                 kycAccessToken= configData?.kycAccessToken
            }
            const contactWrapper = document.getElementById("contactWrapper");
            const emailElement = document.getElementById("contactEmail");      
            if (configData.contactEmail) {
                emailElement.href = `mailto:${configData.contactEmail}`;
                emailElement.textContent = configData.contactEmail;
                } else {
                // Hide the entire "Contact:" line if no email
                contactWrapper.style.display = "none";
             }
            return true;
        } catch (error) {
            console.error('Error loading KYC config from API:', error);
            // API failure is not critical; show fallback banner message
            setSandboxBanner(undefined);
            // Show user-facing error and disable start button
            showConfigLoadError('Unable to load configuration from server. Please check the customer ID in the URL and try again.');
            // Ensure header shows a graceful placeholder instead of a broken image
            handleLogoError(document.getElementById('logo'));
            return false;
        }
    }

    // Original function to load local JSON data
    async function loadJSONData() {
        try {
            const id = getCustomerId(window.location.href)
            
            // If no customer ID, don't proceed
            if (!id) {
                console.warn('No customer ID provided, skipping JSON data load');
                return;
            }
            
            const response = await fetch('tokenDetail.json');
            tokenData = await response.json();
            const matchedData = tokenData.find((tokenDetail) => tokenDetail.id === id)
            ssiAccessToken = matchedData?.ssiAccessToken ?? "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6ImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX3NzaSIsImttc0lkIjoiaHM6ZG9jOmUwbGtycWZheW5xbWNsMWh4MjVmY3htODdtMnBjemVrbTh2dm5zemFqbGEiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiJdLCJzdWJkb21haW4iOiJlbnQtOGEyZGU1YSIsImVkdklkIjoiaHM6ZGV2ZWxvcGVyLWRhc2hib2FyZDphcHA6ZGM4ZTgxYzM0ZGI4NDliNzQyYWMyMWU1YTljZmJhMzA1NTAyIiwiYWNjZXNzTGlzdCI6WyJBTEwiXSwiZW52IjoiZGV2IiwiYXBwTmFtZSI6IlNTSSBTZXJ2aWNlIEZvciBNeURlZmkiLCJpYXQiOjE3MjI2MTcwOTQsImV4cCI6MjI0Mjc4MTA5NH0.CAWghRvyzm2i7qpN5e4vtJkNilBiNndGBLV-DaWqd0w"
            kycAccessToken = matchedData?.kycAccessToken ?? "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6IjEzZjcwZmFmN2Y1YzVkMDM1MjBiNzExODExMzZiNTk1ZjdjNiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX2t5YyIsImttc0lkIjoiaHM6ZG9jOm15cWJldHlwNnctazB6anlkY3liYXZvbncxNGZnb2UzN2RhcDR5Y2NpbzAiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiIsImh0dHBzOi8vZW50aXR5LmRhc2hib2FyZC5oeXBlcnNpZ24uaWQiLCJodHRwczovL3ZlcmlmeS5oeXBlcnNpZ24uaWQiXSwic3ViZG9tYWluIjoiZW50LTRjNzE4NzQiLCJlZHZJZCI6ImhzOmRldmVsb3Blci1kYXNoYm9hcmQ6YXBwOjU0Nzc0OWIyODJmNjI4N2Q3YzhhNjk2MDllNDE5NGFmOTY0YyIsImFjY2Vzc0xpc3QiOlsiQUxMIiwiUkVBRF9VU0VSX0NPTlNFTlQiLCJXUklURV9VU0VSX0NPTlNFTlQiLCJXUklURV9QQVNTSVZFX0xJVkVMSU5FU1MiLCJXUklURV9ET0NfT0NSIl0sImVudiI6ImRldiIsImFwcE5hbWUiOiJOaWJpcnUgKG15RGVmaSkgT25jaGFpbiBLWUMgQXBwIiwiaXNzdWVyRGlkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiIsImlzc3VlclZlcmlmaWNhdGlvbk1ldGhvZElkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiNrZXktMiIsImRlcGVuZGVudFNlcnZpY2VzIjpbImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiJdLCJpYXQiOjE3MzI3NzMzNzIsImV4cCI6MTg5Mjc4MjU3Mn0.C6vKRubBQQDL_TYwp2RE59YgGlcLdifr_jxBsPzSIPw"
            teneantUrl = matchedData?.teneantUrl ?? "https://ent-4c71874.api.cavach.hypersign.id"
            const logoImg = document.getElementById('logo');
            if (matchedData.logoUrl && logoImg) {
                logoImg.src = matchedData.logoUrl;
            } else {
                handleLogoError(logoImg)
            }
        } catch (error) {
            console.error('Error loading the JSON file:', error);
            ssiAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6ImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX3NzaSIsImttc0lkIjoiaHM6ZG9jOmUwbGtycWZheW5xbWNsMWh4MjVmY3htODdtMnBjemVrbTh2dm5zemFqbGEiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiJdLCJzdWJkb21haW4iOiJlbnQtOGEyZGU1YSIsImVkdklkIjoiaHM6ZGV2ZWxvcGVyLWRhc2hib2FyZDphcHA6ZGM4ZTgxYzM0ZGI4NDliNzQyYWMyMWU1YTljZmJhMzA1NTAyIiwiYWNjZXNzTGlzdCI6WyJBTEwiXSwiZW52IjoiZGV2IiwiYXBwTmFtZSI6IlNTSSBTZXJ2aWNlIEZvciBNeURlZmkiLCJpYXQiOjE3MjI2MTcwOTQsImV4cCI6MjI0Mjc4MTA5NH0.CAWghRvyzm2i7qpN5e4vtJkNilBiNndGBLV-DaWqd0w"
            kycAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6IjEzZjcwZmFmN2Y1YzVkMDM1MjBiNzExODExMzZiNTk1ZjdjNiIsInVzZXJJZCI6ImNjZWJlOWNlLWM1MzItNDVmNS1hNzlhLWZkZDRjMzAxYTljOCIsImdyYW50VHlwZSI6ImFjY2Vzc19zZXJ2aWNlX2t5YyIsImttc0lkIjoiaHM6ZG9jOm15cWJldHlwNnctazB6anlkY3liYXZvbncxNGZnb2UzN2RhcDR5Y2NpbzAiLCJ3aGl0ZWxpc3RlZENvcnMiOlsiKiIsImh0dHBzOi8vZW50aXR5LmRhc2hib2FyZC5oeXBlcnNpZ24uaWQiLCJodHRwczovL3ZlcmlmeS5oeXBlcnNpZ24uaWQiXSwic3ViZG9tYWluIjoiZW50LTRjNzE4NzQiLCJlZHZJZCI6ImhzOmRldmVsb3Blci1kYXNoYm9hcmQ6YXBwOjU0Nzc0OWIyODJmNjI4N2Q3YzhhNjk2MDllNDE5NGFmOTY0YyIsImFjY2Vzc0xpc3QiOlsiQUxMIiwiUkVBRF9VU0VSX0NPTlNFTlQiLCJXUklURV9VU0VSX0NPTlNFTlQiLCJXUklURV9QQVNTSVZFX0xJVkVMSU5FU1MiLCJXUklURV9ET0NfT0NSIl0sImVudiI6ImRldiIsImFwcE5hbWUiOiJOaWJpcnUgKG15RGVmaSkgT25jaGFpbiBLWUMgQXBwIiwiaXNzdWVyRGlkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiIsImlzc3VlclZlcmlmaWNhdGlvbk1ldGhvZElkIjoiZGlkOmhpZDp0ZXN0bmV0OjAzNDYwZWU1LWM0ZTQtNGYwNi04NDg3LTU1YTZjMjMwM2JhZiNrZXktMiIsImRlcGVuZGVudFNlcnZpY2VzIjpbImRjOGU4MWMzNGRiODQ5Yjc0MmFjMjFlNWE5Y2ZiYTMwNTUwMiJdLCJpYXQiOjE3MzI3NzMzNzIsImV4cCI6MTg5Mjc4MjU3Mn0.C6vKRubBQQDL_TYwp2RE59YgGlcLdifr_jxBsPzSIPw"
            teneantUrl = "https://ent-4c71874.api.cavach.hypersign.id"
            document.getElementById("logo").src = "https://i.ibb.co/MRV1T6k/mydefi-high-resolution-logo-black-transparent.png";
        }
    }

    const widgetBaseUrl = "https://verify.hypersign.id/"
    const consentAPIpath = '/api/v1/e-kyc/verification/user-consent'
    const kycSessionPath = '/api/v1/e-kyc/verification/session'
    let idwidgetPopup;
    let popupChecker;

    let idTokenGbl = ""

    function onError(message) {
        const errorDom = document.getElementById('errorData')
        if (errorDom) {
            errorDom.style.display = 'block'
            errorDom.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-2xl overflow-x-auto overflow-y-hidden" role="alert">
                <div class="whitespace-nowrap">
                    ${message ? message : `
                        Failed to verify the user, please try again!
                    `}
                </div>
            </div>
            <div class="text-center mt-3 text-lg text-gray-600">Please reload the page and try again</div>
            `
        }
        const button = document.getElementById('load2')
        if (button) {
            button.style.display = 'none'
            button.innerHTML = `<i class="bi bi-person-bounding-box mr-3"></i> Start KYC Verification`
        }
    }

    function clearError() {
        const errorDom = document.getElementById('errorData')
        if (errorDom) {
            errorDom.style.display = 'none'
            errorDom.innerHTML = ''
        }
    }

    function handleLogoError(imgEl) {
        try {
            if (!imgEl) return;
            imgEl.style.display = 'none';
            const header = imgEl.parentElement;
            if (!header) return;
            if (!document.getElementById('logoFallback')) {
                const fallback = document.createElement('div');
                fallback.id = 'logoFallback';
                fallback.className = 'h-12 w-12 rounded-full flex items-center justify-center bg-gray-200 text-gray-600';
                fallback.innerHTML = '<i class="bi bi-image"></i>';
                fallback.title = 'Image not loaded';
                header.insertBefore(fallback, header.firstChild);
            }
        } catch (_) {}
    }

    function handleLogoLoad(imgEl) {
        try {
            if (!imgEl) return;
            // Remove any fallback if present
            const fallback = document.getElementById('logoFallback');
            if (fallback && fallback.parentElement) {
                fallback.parentElement.removeChild(fallback);
            }
            imgEl.style.display = '';
        } catch (_) {}
    }

    function attachLogoHandlers() {
        const img = document.getElementById('logo');
        if (!img) return;
        img.addEventListener('error', function () { handleLogoError(img) });
        img.addEventListener('load', function () {
            const fallback = document.getElementById('logoFallback');
            if (fallback && fallback.parentElement) fallback.parentElement.removeChild(fallback);
            img.style.display = '';
        });
    }

    function disableStartButton() {
        const button = document.getElementById('load2')
        if (button) {
            button.disabled = true
            button.classList.add('opacity-50', 'cursor-not-allowed')
        }
    }

    function showConfigLoadError(message) {
        const errorDom = document.getElementById('errorData')
        if (errorDom) {
            errorDom.style.display = 'block'
            errorDom.innerHTML = `
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl" role="alert">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <i class="bi bi-exclamation-circle mr-2 text-lg text-red-600"></i>
                  <span class="font-semibold">Unable to load configuration</span>
                </div>
                <button id="cfgReadMore" class="text-xs font-medium text-red-700 hover:text-red-900 underline">See more</button>
              </div>
              <div id="cfgDetails" class="hidden mt-2 text-sm text-red-700 overflow-x-auto overflow-y-hidden whitespace-nowrap">
                ${message || 'Please check the customer ID in the URL, your network connection, or try again later. If the issue persists, contact support.'}
              </div>
            </div>
            `
            const readMoreBtn = document.getElementById('cfgReadMore');
            if (readMoreBtn) {
                readMoreBtn.addEventListener('click', function () {
                    const details = document.getElementById('cfgDetails');
                    if (!details) return;
                    const isHidden = details.classList.toggle('hidden');
                    readMoreBtn.textContent = isHidden ? 'See more' : 'Hide';
                });
            }
        }
        const button = document.getElementById('load2')
        if (button) {
            button.style.display = 'none'
        }
    }

    window.addEventListener('message', function (event) {

        if ((new URL(event.origin)).origin === (new URL(widgetBaseUrl)).origin) {
            clearInterval(popupChecker);
            const data = JSON.parse(event.data)
            // Handle the message data sent from the popup
            console.log('Received message from popup:', event.data);
            if (data.status === 'success') {
                const result = document.getElementById('result')
                result.innerHTML = `<h2 class="text-green-600 text-center text-2xl font-semibold"><i class="bi bi-check-circle mr-3"></i> You are verified!</h2>`
                document.getElementById('load2').style.display = 'none'
            }
            else if (data.status === 'error') {
                console.log({ data })
                onError(data.message)
            }
        }
    });
    
    $('#load2').on('click', async function () {
        try {
            // Check for customer ID before proceeding
            const customerId = getCustomerId(window.location.href);
            if (!customerId) {
                onError('Customer ID is required. Please provide a valid customer ID in the URL.');
                return;
            }
            
            var $this = $(this);
            $this.button('loading');
            const button = document.getElementById('load2')
            button.innerHTML = `<span class="spinner-grow spinner-grow-sm mr-3"></span> Verifying User...`
            const url = await getWidgetUrl()
            console.log(url)
            if (url) openMobileWindow(url);
        } catch (e) {
            console.log(e)
            onError(e.message)
            alert(e.message)
        }
    });

    function openMobileWindow(url) {
        // Define the dimensions for a typical mobile phone (e.g., iPhone 12)
        const mobileWidth = 450; // Adjust as needed
        const mobileHeight = 750; // Adjust as needed

        // Get the screen dimensions
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;

        // Calculate the position to center the window
        const left = (screenWidth - mobileWidth) / 2;
        const top = (screenHeight - mobileHeight) / 2;

        // Open the window
        idwidgetPopup = window.open(
            url, // Replace with your desired URL
            '_blank',
            `width=${mobileWidth},height=${mobileHeight},left=${left},top=${top},resizable,scrollbars`
        );

        popupChecker = setInterval(() => {
            console.log('Checking popup status...')
            if (idwidgetPopup.closed) {
                console.log('Popup closed');
                clearInterval(popupChecker);
                // popup was closed manually (accident or on purpose)
                onError('Seems like you rejected the verification request!')
                // handle rejection logic here
            }
        }, 500);
    }

    async function fetchNewKYCSession() {
        const idToken = idTokenGbl
        const url = `${teneantUrl}${kycSessionPath}`
        const headers = {
            'Authorization': 'Bearer ' + kycAccessToken,
            'content-type': 'application/json',
        }
        const resp = await fetch(url, {
            method: 'POST',
            headers
        })

        const json = await resp.json()

        if (json && json.error) {
            console.log(json.error.details?.join(' '))
            throw new Error(json.error.details?.join(' '))
        }
        console.log(json)
        return json.data;
    }

    async function getWidgetUrl() {
        const { sessionId } = await fetchNewKYCSession()
        if (sessionId) {
            const finalUrl = `${widgetBaseUrl}?kycAccessToken=${kycAccessToken}&ssiAccessToken=${ssiAccessToken}&sessionId=${sessionId}`
            return finalUrl
        } else {
            const finalUrl = `${widgetBaseUrl}?kycAccessToken=${kycAccessToken}&ssiAccessToken=${ssiAccessToken}`
            return finalUrl
        }
    }
  </script>
</body>
</html>